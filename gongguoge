<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¼€å¿ƒåŠŸè¿‡æ ¼ Â· æç®€ä¿®èº«ç‰ˆ</title>
    
    <!-- PWA é…ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å¼€å¿ƒåŠŸè¿‡æ ¼">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5904/5904053.png">
    <link id="manifest-link" rel="manifest" href='data:application/json,{"name":"å¼€å¿ƒåŠŸè¿‡æ ¼","short_name":"åŠŸè¿‡æ ¼","start_url":".","display":"standalone","background_color":"#f7f9fb","theme_color":"#8da9c4","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/5904/5904053.png","sizes":"512x512","type":"image/png"}]}'>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #f7f9fb; --accent-color: #8da9c4; }
        body { background-color: var(--bg-color); font-family: 'Noto Sans SC', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        .soft-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        .item-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid transparent; }
        .item-card:active { transform: scale(0.96); filter: brightness(0.95); }
        ::-webkit-scrollbar { display: none; }
        .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.3); }
        .tab-active { color: var(--accent-color); position: relative; }
        .tab-active::after { content: ''; position: absolute; bottom: 6px; width: 12px; height: 4px; background: var(--accent-color); border-radius: 10px; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0, 0, 0.2, 1); }
    </style>
</head>
<body class="pb-28">

    <!-- é¡¶æ  -->
    <div class="sticky top-0 z-50 px-6 py-4 flex justify-between items-end bg-[#f7f9fb]/80 backdrop-blur-md">
        <div>
            <h1 class="text-2xl font-black text-slate-700 tracking-tight">å¼€å¿ƒå®ä¿®</h1>
            <p id="topDate" class="text-[11px] text-slate-400 font-medium mt-1"></p>
        </div>
        <div class="bg-white px-4 py-2 rounded-2xl soft-shadow text-right min-w-[100px]">
            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">ä»Šæ—¥å‡€åˆ†</p>
            <p id="topNetScore" class="text-2xl font-black italic text-slate-700">0</p>
        </div>
    </div>

    <main class="px-5">
        <!-- é¡µé¢ï¼šè®°å½• -->
        <div id="page-record">
            <div class="flex p-1.5 bg-slate-200/50 rounded-3xl mb-6 gap-1">
                <button onclick="changeType('gong')" id="btn-gong" class="flex-1 py-3 rounded-2xl text-sm font-bold bg-white text-emerald-600 soft-shadow">ğŸŒ¿ ç§¯åŠŸ <span id="countGong">0</span></button>
                <button onclick="changeType('guo')" id="btn-guo" class="flex-1 py-3 rounded-2xl text-sm font-bold text-slate-400">â˜ï¸ æ”¹è¿‡ <span id="countGuo">0</span></button>
            </div>
            <div class="relative mb-6">
                <input type="text" id="searchInput" oninput="renderList()" placeholder="æœç´¢è§‰å¯Ÿ..." class="w-full pl-11 pr-4 py-3.5 rounded-2xl bg-white border-none soft-shadow text-sm focus:ring-2 focus:ring-blue-100 placeholder-slate-300">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 opacity-30">ğŸ”</span>
            </div>
            <div id="itemList" class="space-y-4"></div>
        </div>

        <!-- é¡µé¢ï¼šæ—¥å† -->
        <div id="page-calendar" class="hidden">
            <div class="bg-white rounded-[2rem] p-6 soft-shadow mb-6">
                <div class="flex justify-between items-center mb-6 px-2">
                    <button onclick="moveMonth(-1)" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-50 text-slate-400">â€¹</button>
                    <h2 id="calMonthTitle" class="font-bold text-slate-700"></h2>
                    <button onclick="moveMonth(1)" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-50 text-slate-400">â€º</button>
                </div>
                <div id="calGrid" class="grid grid-cols-7 gap-2 text-center text-[10px]"></div>
            </div>
            <div id="dayDetail" class="bg-white/60 rounded-[2rem] p-6 border border-white hidden">
                <h3 class="font-bold text-slate-600 mb-4" id="detailDate"></h3>
                <ul id="detailList" class="space-y-3"></ul>
            </div>
        </div>

        <!-- é¡µé¢ï¼šç»Ÿè®¡ -->
        <div id="page-stats" class="hidden text-center">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-[#eef5f2] p-6 rounded-[2rem] border border-white">
                    <p class="text-[10px] text-emerald-600 font-bold mb-1">æœ¬æœˆå‡€åˆ†</p>
                    <p id="statMonthScore" class="text-3xl font-black text-emerald-700">0</p>
                </div>
                <div class="bg-[#fcf8f1] p-6 rounded-[2rem] border border-white">
                    <p class="text-[10px] text-amber-600 font-bold mb-1">ç²¾è¿›å¤©æ•°</p>
                    <p id="statMonthDays" class="text-3xl font-black text-amber-700">0</p>
                </div>
            </div>
            <div class="bg-white p-8 rounded-[2rem] soft-shadow text-slate-500 text-sm" id="analysisContent"></div>
        </div>

        <!-- é¡µé¢ï¼šç®¡ç† -->
        <div id="page-manage" class="hidden">
            <div class="space-y-4">
                <!-- æ·»åŠ åˆ°æ¡Œé¢å¡ç‰‡ -->
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-[2rem] text-white shadow-xl shadow-indigo-100">
                    <h3 class="font-bold text-lg mb-1 italic">å¼€å¯æ¡Œé¢æç®€æ¨¡å¼</h3>
                    <p class="text-[10px] opacity-80 mb-5">æ— éœ€æ‰“å¼€æµè§ˆå™¨ï¼Œä»æ¡Œé¢ä¸€é”®ä¿®è¡Œ</p>
                    <button onclick="handleInstall()" class="w-full py-4 bg-white text-indigo-600 font-black rounded-2xl soft-shadow active:scale-95 transition-all">
                        ğŸ“² ç«‹å³æ·»åŠ åˆ°æ¡Œé¢
                    </button>
                </div>

                <div class="bg-white p-6 rounded-[2rem] soft-shadow">
                    <h3 class="font-bold text-slate-700 mb-4">ğŸª™ åŠ©æé‡‘é’±æ¢ç®—</h3>
                    <div class="flex items-center gap-3 bg-slate-50 p-4 rounded-2xl">
                        <span class="text-xs text-slate-400">æ¯æ¶‰åŠ</span>
                        <input type="number" id="moneyRateInput" onchange="saveRate()" class="w-20 bg-transparent font-black text-blue-500 text-center outline-none border-b-2 border-blue-100">
                        <span class="text-xs text-slate-400">å…ƒï¼Œè®° 1 åˆ†</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="doExport()" class="w-full py-4 bg-white text-slate-600 font-bold rounded-2xl soft-shadow">ğŸ“¤ å¤‡ä»½æ•°æ®åˆ°æœ¬åœ°</button>
                    <button onclick="doClear()" class="w-full py-4 bg-red-50 text-red-400 font-bold rounded-2xl mt-4">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
                </div>
            </div>
        </div>
    </main>

    <!-- å¼•å¯¼å¼¹çª— (é€šç”¨ç‰ˆ) -->
    <div id="install-guide" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeGuide()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[3rem] p-8 animate-slide-up">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>
            <h3 id="guide-title" class="text-xl font-black text-slate-800 mb-6 text-center">æ·»åŠ åˆ°æ¡Œé¢</h3>
            <div id="guide-content" class="space-y-6 mb-10 text-slate-600 text-sm italic">
                <!-- åŠ¨æ€æ³¨å…¥å†…å®¹ -->
            </div>
            <button onclick="closeGuide()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl">å¥½ï¼Œæˆ‘å»è¯•è¯•</button>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="fixed bottom-6 left-6 right-6 h-20 glass-nav rounded-[2.5rem] soft-shadow flex justify-around items-center z-50 px-2">
        <button onclick="showPage('record')" id="nav-record" class="flex-1 flex flex-col items-center gap-1 tab-active"><span class="text-xl">âœ¨</span><span class="text-[10px] font-bold">ä¿®æŒ</span></button>
        <button onclick="showPage('calendar')" id="nav-calendar" class="flex-1 flex flex-col items-center gap-1 text-slate-300"><span class="text-xl">ğŸ“…</span><span class="text-[10px] font-bold">æ—¶å…‰</span></button>
        <button onclick="showPage('stats')" id="nav-stats" class="flex-1 flex flex-col items-center gap-1 text-slate-300"><span class="text-xl">ğŸ“ˆ</span><span class="text-[10px] font-bold">ç²¾è¿›</span></button>
        <button onclick="showPage('manage')" id="nav-manage" class="flex-1 flex flex-col items-center gap-1 text-slate-300"><span class="text-xl">âš™ï¸</span><span class="text-[10px] font-bold">è®¾ç½®</span></button>
    </nav>

<script>
// --- æ•°æ®åº“ ---
const DB = {
    gong: [
        {s:100, t:"æ•‘å…ä¸€äººæ­»", m:"æ•‘äººæ€§å‘½/é‡å¤§æ•‘æ´"}, {s:100, t:"å®Œä¸€å¦‡å¥³èŠ‚", m:"å®ˆæŠ¤ä»–äººè´æ´åèª‰"}, {s:100, t:"é˜»äººä¸æººä¸€å­å¥³", m:"ä¿æŠ¤å©´å¹¼å„¿ç”Ÿå‘½"}, {s:100, t:"ä¸ºäººå»¶ä¸€å—£", m:"åŠ©äººæˆå®¶ç«‹ä¸š"},
        {s:50, t:"å…å •ä¸€èƒ", m:"åŠé˜»å •èƒ"}, {s:50, t:"å½“æ¬²æŸ“å¢ƒï¼Œå®ˆæ­£ä¸æŸ“", m:"é¢å¯¹è¯±æƒ‘ä¿æŒæ“å®ˆ"}, {s:50, t:"æ”¶å…»ä¸€æ— å€š", m:"ç…§é¡¾å­¤å„¿/æ— ä¾æ— é "}, {s:50, t:"è‘¬ä¸€æ— ä¸»éª¸éª¨", m:"å®‰è‘¬æ— åé—éª¸"}, {s:50, t:"æ•‘å…ä¸€äººæµç¦»", m:"å¸®äººå®‰é¡¿å®¶å›­"}, {s:50, t:"æ•‘å…ä¸€äººå†›å¾’é‡ç½ª", m: "æ³•å¾‹æ´åŠ©å…é‡åˆ‘"}, {s:50, t:"ç™½ä¸€äººå†¤", m:"æ´—æ¸…å†¤å±ˆ"}, {s:50, t:"å‘ä¸€è¨€åˆ©åŠç™¾å§“", m:"åˆ©æ°‘å»ºè®®"},
        {s:30, t:"æ–½ä¸€è‘¬åœ°ä¸æ— åœŸä¹‹å®¶", m:"æèµ å¢“åœ°"}, {s:30, t:"åŒ–ä¸€ä¸ºéè€…æ”¹è¡Œ", m:"å¼•å¯¼ä½œæ¶è€…æ”¹è¿‡"}, {s:30, t:"åº¦ä¸€å—æˆ’å¼Ÿå­", m:"å¼•å¯¼ä¿¡ä»°"}, {s:30, t:"å®Œèšä¸€äººå¤«å¦‡", m:"ä¿ƒæˆå®¶åº­å›¢åœ†"}, {s:30, t:"æ”¶å…»ä¸€æ— ä¸»é—å¼ƒé—¨å­©", m:"æ”¶å…»å¼ƒå„¿"}, {s:30, t:"æˆå°±ä¸€äººå¾·ä¸š", m:"èµ„åŠ©å®Œæˆå“å­¦"},
        {s:10, t:"èå¼•ä¸€æœ‰å¾·äºº", m:"ä¸¾è´¤èèƒ½"}, {s:10, t:"é™¤ä¸€äººå®³", m:"æ¶ˆé™¤ç¤¾ä¼šéšæ‚£"}, {s:10, t:"ç¼–çº‚ä¸€åˆ‡ä¼—ç»æ³•", m:"ä¼ æ’­ç»å…¸"}, {s:10, t:"ä»¥æ–¹æœ¯æ²»ä¸€äººé‡ç—…", m:"åŒ»æ²»é‡ç–¾"}, {s:10, t:"å‘è‡³å¾·ä¹‹è¨€", m:"å‘è¡¨æå–„è¨€è®º"}, {s:10, t:"æœ‰è´¢åŠ¿å¯ä½¿è€Œä¸ä½¿", m:"æœ‰æƒä¸æ»¥ç”¨"}, {s:10, t:"å–„é—å¦¾å©¢", m:"å–„å¾…ä¸‹å±"}, {s:10, t:"æ•‘ä¸€æœ‰åŠ›æŠ¥äººä¹‹ç•œå‘½", m:"æ•‘åŠŸåŠ³åŠ¨ç‰©"},
        {s:5, t:"åŠæ¯ä¸€äººè®¼", m:"å¹³æ¯æ¶æ„å®˜å¸"}, {s:5, t:"ä¼ äººä¸€ä¿ç›Šæ€§å‘½äº‹", m:"åˆ†äº«å¥åº·å¸¸è¯†"}, {s:5, t:"ç¼–çº‚ä¸€ä¿ç›Šæ€§å‘½ç»æ³•", m:"ç¼–å†™ç›Šå¯¿å†…å®¹"}, {s:5, t:"ä»¥æ–¹æœ¯æ•‘ä¸€äººè½»ç–¾", m:"æ²»æ„ˆè½»å¾®ç—…ç—‡"}, {s:5, t:"åŠæ­¢ä¼ æ’­äººæ¶", m:"é˜»æ­¢æ˜¯é"}, {s:5, t:"ä¾›å…»ä¸€è´¤å–„äºº", m:"èµ„åŠ©æœ‰å¾·ä¿®è¡Œè€…"}, {s:5, t:"ç¥ˆç¦ç¦³ç¾ç­‰ï¼Œè®¸å–„æ„¿ä¸æ€ç”Ÿ", m:"ä¸æ€ç”Ÿç¯ä¿å¿ƒæ„¿"}, {s:5, t:"æ•‘ä¸€æ— åŠ›æŠ¥äººä¹‹ç•œå‘½", m:"æ•‘åŠ©ä¸€èˆ¬å°åŠ¨ç‰©"},
        {s:3, t:"å—ä¸€æ¨ªä¸å—”", m:"é‡æ¨ªç¥¸ä¸åŠ¨æ€’"}, {s:3, t:"ä»»ä¸€è°¤ä¸è¾©", m:"é­è¯½è°¤ä¸äº‰è¾©"}, {s:3, t:"å—ä¸€é€†è€³è¨€", m:"è™šå¿ƒæ¥å—æ‰¹è¯„"}, {s:3, t:"å…ä¸€åº”è´£äºº", m:"å®½æ•åº”è´£è€…"}, {s:3, t:"åŠæ€ç”Ÿè€…æ”¹ä¸š", m:"åŠå± å¤«çŒäººæ”¹è¡Œ"}, {s:3, t:"è‘¬ä¸€è‡ªæ­»ç•œç±»", m:"æ©åŸ‹æ­»ååŠ¨ç‰©"},
        {s:1, t:"èµä¸€äººå–„", m:"è¡¨æ‰¬ä»–äºº"}, {s:1, t:"æ©ä¸€äººæ¶", m:"ä¸ºäººé®ä¸‘"}, {s:1, t:"åŠæ¯ä¸€äººäº‰", m:"è°ƒè§£çº çº·"}, {s:1, t:"é˜»äººä¸€éä¸ºäº‹", m:"é˜»æ­¢é”™äº‹"}, {s:1, t:"æµä¸€äººé¥¥", m:"ç»™é¥­åƒ"}, {s:1, t:"ç•™æ— å½’äººä¸€å®¿", m:"æä¾›ä½å®¿"}, {s:1, t:"æ•‘ä¸€äººå¯’", m:"ç»™è¡£ç©¿"}, {s:1, t:"æ–½è¯ä¸€æœ", m:"æ–½èˆè¯ç‰©"}, {s:1, t:"æ–½è¡ŒåŠæµäººä¹¦æ–‡", m:"ä¼ æ’­å–„ä¹¦"}, {s:1, t:"è¯µç»ä¸€å·", m:"å®ŒæˆåŠŸè¯¾"}, {s:1, t:"ç¤¼å¿ç™¾æ‹œ", m:"å¿æ‚”ç™¾æ¬¡"}, {s:1, t:"è¯µä½›å·åƒå£°", m:"å¿µä½›åƒå£°"}, {s:1, t:"è®²æ¼”å–„æ³•ï¼Œè°•åŠåäºº", m:"å®£è®²æ™ºæ…§"}, {s:1, t:"å…´äº‹åˆ©åŠåäºº", m:"åˆ©ç›Šåäºº"}, {s:1, t:"æ‹¾å¾—é—å­—ä¸€åƒ", m:"æ•¬æƒœå­—çº¸"}, {s:1, t:"é¥­ä¸€åƒ§", m:"ä¾›å…»ä¿®è¡Œè€…é¥­é£Ÿ"}, {s:1, t:"æŠ¤æŒåƒ§ä¼—ä¸€äºº", m:"æŠ¤æŒä¿®è¡Œäºº"}, {s:1, t:"ä¸æ‹’ä¹äºº", m:"ç¤¼å¾…ä¹è®¨è€…"}, {s:1, t:"æ¥æµäººç•œä¸€æ—¶ç–²é¡¿", m:"å¸®äººå‡è½»ç–²ç´¯"}, {s:1, t: "è§äººæœ‰å¿§ï¼Œå–„ä¸ºè§£æ…°", m:"å®‰æ…°ä»–äºº"}, {s:1, t:"è‚‰é£ŸäººæŒæ–‹ä¸€æ—¥", m:"èŒ¹ç´ ä¸€å¤©"}, {s:1, t:"è§æ€ä¸é£Ÿã€‚é—»æ€ä¸é£Ÿã€‚ä¸ºå·±æ€ä¸é£Ÿ", m:"ä¸‰ä¸é£ŸåŸåˆ™"}, {s:1, t:"è‘¬ä¸€è‡ªæ­»ç¦½ç±»", m:"åŸ‹è‘¬å°é¸Ÿ"}, {s:1, t:"æ”¾ä¸€ç”Ÿ", m:"è§£æ•‘ç”Ÿå‘½"}, {s:1, t:"æ•‘ä¸€ç»†å¾®æ¹¿åŒ–ä¹‹å±å‘½", m:"æ•‘æ˜†è™«èš‚èš"},
        {s:1, t:"ä½œåŠŸæœèæ²‰é­‚", isM:true}, {s:1, t:"æ•£é’±ç²Ÿè¡£å¸›æµäºº", isM:true}, {s:1, t:"é¥¶äººå€ºè´Ÿ", isM:true}, {s:1, t:"è¿˜äººé—ç‰©", isM:true}, {s:1, t:"ä¸ä¹‰ä¹‹è´¢ä¸å–", isM:true}, {s:1, t:"ä»£äººå®Œçº³å€ºè´Ÿ", isM:true}, {s:1, t:"è®©åœ°è®©äº§", isM:true}, {s:1, t:"åŠäººå‡ºè´¢ä½œç§ç§åŠŸå¾·", isM:true}, {s:1, t:"ä¸è´Ÿå¯„æ‰˜è´¢ç‰©", isM:true}, {s:1, t:"å»ºä»“å¹³ç²œã€ä¿®é€ è·¯æ¡¥ã€ç–æ²³æ˜äº•", isM:true}, {s:1, t:"ä¿®ç½®ä¸‰å®å¯ºé™¢ã€é€ ä¸‰å®å°ŠåƒåŠæ–½é¦™çƒ›ç¯æ²¹ç­‰", isM:true}, {s:1, t:"æ–½èŒ¶æ°´ã€èˆæ£ºæœ¨ä¸€åˆ‡æ–¹ä¾¿ç­‰äº‹", isM:true}
    ],
    guo: [
        {s:100, t:"è‡´ä¸€äººæ­»", m:"é—´æ¥å®³å‘½"}, {s:100, t:"å¤±ä¸€å¦‡å¥³èŠ‚", m:"æ¯äººåèª‰"}, {s:100, t:"èµäººæººä¸€å­å¥³", m:"æ”¯æŒå¼ƒå©´"}, {s:100, t:"ç»ä¸€äººå—£", m:"ç»äººåä»£"},
        {s:50, t:"å •ä¸€èƒ", m:"å‚ä¸å •èƒ"}, {s:50, t:"ç ´ä¸€äººå©š", m:"æ‹†æ•£å©šå§»"}, {s:50, t:"æŠ›ä¸€äººéª¸", m:"äºµæ¸é—éª¨"}, {s:50, t:"è°‹äººå¦»å¥³", m:"ä¸æ­£å½“å…³ç³»"}, {s:50, t:"è‡´ä¸€äººæµç¦»", m:"å®³äººå®¶ç ´æµè½"}, {s:50, t:"è‡´ä¸€äººå†›å¾’é‡ç½ª", m:"é™·äººé‡ç½ª"}, {s:50, t:"æ•™äººä¸å¿ ä¸å­å¤§æ¶ç­‰äº‹", m:"ç…½åŠ¨æ¶è¡Œ"}, {s:50, t:"å‘ä¸€è¨€å®³åŠç™¾å§“", m:"æ¶è¨€å®³ä¼—"},
        {s:30, t:"é€ è°¤æ±¡é™·ä¸€äºº", m:"æé€ è¯‹æ¯"}, {s:30, t:"æ‘˜å‘ä¸€äººé˜´ç§ä¸è¡Œæ­¢äº‹", m:"æ•£å¸ƒéšç§"}, {s:30, t:"å”†ä¸€äººè®¼", m:"æŒ‘åŠ¨è¯‰è®¼"}, {s:30, t:"æ¯ä¸€äººæˆ’è¡Œ", m:"è¯±å¯¼ç ´æˆ’"}, {s:30, t:"åèƒŒå¸ˆé•¿", m:"èƒŒå›æ©å¸ˆæ•™è¯²"}, {s:30, t:"æŠµè§¦çˆ¶å…„", m:"é¡¶æ’é•¿è¾ˆ"}, {s:30, t:"ç¦»é—´äººéª¨è‚‰", m:"æŒ‘æ‹¨äº²æƒ…"}, {s:30, t:"è’å¹´ç§¯å›¤äº”è°·ä¸ç²œç”Ÿç´¢", m:"å›°éš¾æœŸç‰Ÿæš´åˆ©"},
        {s:10, t:"æ’æ‘ˆä¸€æœ‰å¾·äºº", m:"æ‰“å‡»è´¤èƒ½"}, {s:10, t:"èç”¨ä¸€åŒªäºº", m:"é‡ç”¨æ¶äºº"}, {s:10, t:"å¹³äººä¸€å†¢", m:"ç ´åå¢“ç©´"}, {s:10, t:"å‡Œå­¤é€¼å¯¡", m:"æ¬ºå‹å¼±åŠ¿"}, {s:10, t:"å—ç•œä¸€å¤±èŠ‚å¦‡", m:"æ”¶ç•™è¯±å¾·"}, {s:10, t:"ç•œä¸€æ€ä¼—ç”Ÿå…·", m:"ç»è¥æ€å™¨"}, {s:10, t:"æ¶è¯­å‘å°Šäº²ã€å¸ˆé•¿ã€è‰¯å„’", m:"å¯¹å®¶äº²ç²—æš´"}, {s:10, t:"ä¿®åˆå®³äººæ¯’è¯", m:"åˆ¶å‡è¯æœ‰å®³ç‰©"}, {s:10, t:"éæ³•ç”¨åˆ‘", m:"ç§åˆ‘"}, {s:10, t:"æ¯åä¸€åˆ‡æ­£æ³•ç»å…¸", m:"ä¸é‡ç»å…¸"}, {s:10, t:"è¯µç»æ—¶ï¼Œå¿ƒä¸­æ‚æƒ³æ¶äº‹", m:"ä¿®è¡Œä¸ä¸“å¿ƒ"}, {s:10, t:"ä»¥å¤–é“é‚ªæ³•æˆäºº", m:"ä¼ æ’­é‚ªè§"}, {s:10, t:"å‘æŸå¾·ä¹‹è¨€", m:"æŸå¾·è¯"}, {s:10, t:"æ€ä¸€æœ‰åŠ›æŠ¥äººä¹‹ç•œå‘½", m:"æ€åŠŸåŠ³åŠ¨ç‰©"},
        {s:5, t:"è®ªè°¤ä¸€åˆ‡æ­£æ³•ç»å…¸", m:"è¯½è°¤çœŸç†"}, {s:5, t:"è§ä¸€å†¤å¯ç™½ä¸ç™½", m:"ä¸ç”³æ­£ä¹‰"}, {s:5, t:"é‡ä¸€ç—…æ±‚æ•‘ä¸æ•‘", m:"è§æ€¥ä¸æ•‘"}, {s:5, t:"é˜»ç»ä¸€é“è·¯æ¡¥æ¢", m:"ç ´åäº¤é€š"}, {s:5, t:"ç¼–çº‚ä¸€ä¼¤åŒ–è¯ä¼ ", m:"ä¼ æ’­åº¸ä¿—"}, {s:5, t:"é€ ä¸€æµ‘åæ­Œè°£", m:"ä¼ è°£ä¾®è¾±"}, {s:5, t:"æ¶å£çŠ¯å¹³äº¤", m:"å¯¹å‹æ¶è¯­"}, {s:5, t:"æ€ä¸€æ— åŠ›æŠ¥äººä¹‹ç•œå‘½", m:"æ€ä¸€èˆ¬åŠ¨ç‰©"}, {s:5, t:"éæ³•çƒ¹ç‚®ç”Ÿç‰©ï¼Œä½¿å—æè‹¦", m:"æ®‹å¿æ€ç”Ÿ"},
        {s:3, t:"å—”ä¸€é€†è€³è¨€", m:"æ‹’è°åŠ¨æ€’"}, {s:3, t:"ä¹–ä¸€å°Šå‘æ¬¡", m:"ä¹±äº†ç¤¼æ•°"}, {s:3, t:"è´£ä¸€ä¸åº”è´£äºº", m:"æ€ªé”™å¥½äºº"}, {s:3, t:"æ’­ä¸€äººæ¶", m:"å®£æ‰¬åå¤„"}, {s:3, t:"ä¸¤èˆŒç¦»é—´ä¸€äºº", m:"æ¬å¼„æ˜¯é"}, {s:3, t:"æ¬ºè¯³ä¸€æ— è¯†", m:"éª—è€å®äºº"}, {s:3, t:"æ¯äººæˆåŠŸ", m:"åäººå¥½äº‹"}, {s:3, t:"è§äººæœ‰å¿§ï¼Œå¿ƒç”Ÿç•…å¿«", m:"äººå¿§å·±ä¹"}, {s:3, t:"è§äººå¤±åˆ©ã€å¤±åï¼Œå¿ƒç”Ÿæ¬¢å–œ", m:"å¹¸ç¾ä¹ç¥¸"}, {s:3, t:"è§äººå¯Œè´µï¼Œæ„¿ä»–è´«è´±", m:"ä»‡å¯Œå¿ƒ"}, {s:3, t:"å¤±æ„è¾„æ€¨å¤©å°¤äºº", m:"æŠ±æ€¨ç¯å¢ƒ"}, {s:3, t:"åˆ†å¤–è¥æ±‚", m:"è´ªå©ª"},
        {s:1, t:"æ²¡ä¸€äººå–„", m:"æŠ¹ç…ä»–å¾·"}, {s:1, t:"å”†ä¸€äººæ–—", m:"æŒ‘å”†æ–—äº‰"}, {s:1, t:"å¿ƒä¸­æš—ä¸¾æ¶æ„å®³äºº", m:"èµ·å®³å¿ƒ"}, {s:1, t:"åŠ©äººä¸ºéä¸€äº‹", m:"å¸®äººä½œæ¶"}, {s:1, t:"è§äººç›—ç»†ç‰©ä¸é˜»", m:"çºµå®¹å°ç›—"}, {s:1, t:"è§äººå¿§æƒŠä¸æ…°", m:"å†·æ¼ "}, {s:1, t:"å½¹äººç•œï¼Œä¸æ€œç–²é¡¿", m:"ä¸æ¤åŠ³åŠ›"}, {s:1, t:"ä¸å‘Šäººå–äººä¸€é’ˆä¸€è‰", m:"æ‹¿å°ä¾¿å®œ"}, {s:1, t:"é—å¼ƒå­—çº¸", m:"ä¸é‡å­—çº¸"}, {s:1, t:"æš´å¼ƒäº”è°·å¤©ç‰©", m:"æµªè´¹ç²®é£Ÿ"}, {s:1, t:"è´Ÿä¸€çº¦", m:"è¿çº¦"}, {s:1, t:"é†‰çŠ¯ä¸€äºº", m:"é…’åå†’çŠ¯"}, {s:1, t:"è§ä¸€äººé¥¥å¯’ä¸æ•‘æµ", m:"ä¸æ•‘æ€¥"}, {s:1, t:"è¯µç»å·®æ¼ä¸€å­—å¥", m:"å¿µç»ä¸è™”"}, {s:1, t:"åƒ§äººä¹é£Ÿä¸ä¸", m:"æ‹’åƒ§"}, {s:1, t:"æ‹’ä¸€ä¹äºº", m:"æ¶å¾…ä¹ä¸"}, {s:1, t:"é£Ÿé…’è‚‰äº”è¾›ï¼Œè¯µç»ç™»ä¸‰å®åœ°", m:"å¤±ç¦å¿Œ"}, {s:1, t:"æœä¸€éæ³•æœ", m:"ç©¿æˆ´ä¸å½“"}, {s:1, t:"é£Ÿä¸€æŠ¥äººä¹‹ç•œç­‰è‚‰", m:"åƒåŠŸåŠ³ç•œè‚‰"}, {s:1, t:"æ€ä¸€ç»†å¾®æ¹¿åŒ–å±å‘½ä»¥åŠå±¥å·¢ç ´åµç­‰äº‹", m:"ä¼¤å¾®å‘½"},
        {s:1, t:"èƒŒä¼—å—åˆ©ï¼Œä¼¤ç”¨ä»–é’±", isM:true}, {s:1, t:"è´Ÿè´·", isM:true}, {s:1, t:"è´Ÿé—", isM:true}, {s:1, t:"è´Ÿå¯„æ‰˜è´¢ç‰©", isM:true}, {s:1, t:"å› å…¬æƒåŠ¿ä¹ç´¢ã€å·§ç´¢ï¼Œå–äººä¸€åˆ‡è´¢ç‰©", isM:true}, {s:1, t:"åºŸåä¸‰å®å°Šåƒä»¥åŠæ®¿å®‡ã€å™¨ç”¨ç­‰ç‰©", isM:true}, {s:1, t:"æ–—ç§¤ç­‰å°å‡ºå¤§å…¥", isM:true}, {s:1, t:"è´©å–å± åˆ€ã€æ¸”ç½‘ç­‰ç‰©", isM:true}
    ]
};

// --- PWA Service Worker æ³¨å†Œ (å…³é”®) ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const swBlob = new Blob([`self.addEventListener('fetch', (e) => {});`], {type: 'text/javascript'});
        navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(()=>{});
    });
}

// --- å˜é‡ä¸åˆå§‹åŒ– ---
let logs = JSON.parse(localStorage.getItem('kaixin_160_final') || '[]');
let rate = parseFloat(localStorage.getItem('kaixin_money_rate') || '100');
let currentType = 'gong';
let viewDate = new Date();
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
});

function init() {
    const today = new Date();
    document.getElementById('topDate').innerText = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥ Â· ${['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][today.getDay()]}`;
    document.getElementById('moneyRateInput').value = rate;
    renderList();
    updateScore();
}

// --- å®‰è£…æ¡Œé¢é€»è¾‘ ---
function handleInstall() {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const guide = document.getElementById('install-guide');
    const content = document.getElementById('guide-content');
    const title = document.getElementById('guide-title');

    if (isIOS) {
        title.innerText = "è‹¹æœæ‰‹æœºæ·»åŠ æŒ‡å—";
        content.innerHTML = `
            <div class="flex items-center gap-4"><div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center">1</div><p>ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨çš„â€œåˆ†äº«â€æŒ‰é’® (æ–¹æ¡†å‘ä¸Šç®­å¤´)</p></div>
            <div class="flex items-center gap-4"><div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center">2</div><p>å‘ä¸Šæ»‘åŠ¨ï¼Œæ‰¾åˆ°â€œæ·»åŠ åˆ°ä¸»å±å¹•â€</p></div>
            <div class="flex items-center gap-4"><div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center">3</div><p>ç‚¹å‡»å³ä¸Šè§’çš„â€œæ·»åŠ â€å³å¯</p></div>
        `;
        guide.classList.remove('hidden');
    } else if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => { deferredPrompt = null; });
    } else {
        title.innerText = "å®‰å“æ‰‹æœºæ·»åŠ æŒ‡å—";
        content.innerHTML = `
            <p class="text-amber-500 mb-4 font-bold">ç”±äºæ‚¨æ˜¯åœ¨æ–‡ä»¶æ¨¡å¼ä¸‹æ‰“å¼€ï¼Œæ— æ³•è‡ªåŠ¨å¼¹å‡ºå®‰è£…æ¡†ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨æ·»åŠ ï¼š</p>
            <div class="flex items-center gap-4"><div class="w-8 h-8 bg-indigo-50 rounded-full flex items-center justify-center">1</div><p>ç‚¹å‡» Chrome å³ä¸Šè§’â€œä¸‰ä¸ªç‚¹ â‹®â€èœå•</p></div>
            <div class="flex items-center gap-4"><div class="w-8 h-8 bg-indigo-50 rounded-full flex items-center justify-center">2</div><p>æ‰¾åˆ°â€œæ·»åŠ åˆ°ä¸»å±å¹•â€æˆ–â€œå®‰è£…åº”ç”¨â€</p></div>
            <div class="flex items-center gap-4"><div class="w-8 h-8 bg-indigo-50 rounded-full flex items-center justify-center">3</div><p>ç¡®è®¤æ·»åŠ ï¼Œå›¾æ ‡å³ä¼šå‡ºç°åœ¨æ¡Œé¢</p></div>
        `;
        guide.classList.remove('hidden');
    }
}

function closeGuide() { document.getElementById('install-guide').classList.add('hidden'); }

// --- ä¸šåŠ¡é€»è¾‘ ---
function changeType(t) {
    currentType = t;
    const isGong = t === 'gong';
    document.getElementById('btn-gong').className = isGong ? 'flex-1 py-3 rounded-2xl text-sm font-bold bg-white text-emerald-600 soft-shadow' : 'flex-1 py-3 rounded-2xl text-sm font-bold text-slate-400';
    document.getElementById('btn-guo').className = !isGong ? 'flex-1 py-3 rounded-2xl text-sm font-bold bg-white text-rose-500 soft-shadow' : 'flex-1 py-3 rounded-2xl text-sm font-bold text-slate-400';
    renderList();
}

function renderList() {
    const list = document.getElementById('itemList');
    const search = document.getElementById('searchInput').value.toLowerCase();
    const data = DB[currentType];
    const filtered = data.filter(i => i.t.includes(search));
    list.innerHTML = filtered.map(i => `
        <div class="item-card bg-white p-5 rounded-[1.5rem] soft-shadow flex justify-between items-center" onclick="handleClick('${i.t}', ${i.s}, ${!!i.isM})">
            <div class="flex-1 pr-4">
                <div class="flex items-center gap-2 mb-1.5"><span class="text-[9px] font-bold px-2 py-0.5 rounded-full ${currentType==='gong'?'bg-emerald-50 text-emerald-500':'bg-rose-50 text-rose-400'}">å‡†${i.s}çº§</span><span class="text-[15px] font-bold text-slate-700">${i.t}</span></div>
                <p class="text-[11px] text-slate-400 leading-tight">${i.isM ? `æ¯æ¶‰åŠ ${rate} å…ƒè®° 1 åˆ†` : (i.m || "ä¿æŒè§‰å¯Ÿ")}</p>
            </div>
            <span class="text-xl font-black ${currentType==='gong'?'text-emerald-500':'text-rose-400'}">${currentType==='gong'?'+':'-'}</span>
        </div>
    `).join('');
    document.getElementById('countGong').innerText = DB.gong.length;
    document.getElementById('countGuo').innerText = DB.guo.length;
}

function handleClick(t, s, isM) {
    const mult = currentType === 'gong' ? 1 : -1;
    if (isM) {
        const amt = prompt(`è¯·è¾“å…¥æ¶‰åŠé‡‘é¢ï¼ˆ${rate}å…ƒ/åˆ†ï¼‰ï¼š`, rate);
        if (amt && !isNaN(amt)) addLog(`${t}(${amt}å…ƒ)`, Math.floor(amt / rate) * s * mult);
    } else addLog(t, s * mult);
}

function addLog(t, s) {
    logs.push({ t, s, d: new Date().toISOString().split('T')[0], ts: Date.now() });
    localStorage.setItem('kaixin_160_final', JSON.stringify(logs));
    updateScore();
    if(navigator.vibrate) navigator.vibrate(40);
}

function updateScore() {
    const today = new Date().toISOString().split('T')[0];
    const score = logs.filter(l => l.d === today).reduce((sum, l) => sum + l.s, 0);
    const el = document.getElementById('topNetScore');
    el.innerText = (score > 0 ? '+' : '') + score;
    el.className = `text-2xl font-black italic ${score > 0 ? 'text-emerald-500' : (score < 0 ? 'text-rose-400' : 'text-slate-700')}`;
}

function showPage(p) {
    ['record', 'calendar', 'stats', 'manage'].forEach(id => {
        document.getElementById(`page-${id}`).classList.add('hidden');
        document.getElementById(`nav-${id}`).classList.replace('tab-active', 'text-slate-300');
    });
    document.getElementById(`page-${p}`).classList.remove('hidden');
    document.getElementById(`nav-${p}`).classList.replace('text-slate-300', 'tab-active');
    if(p === 'calendar') renderCalendar();
    if(p === 'stats') renderStats();
}

function moveMonth(s) { viewDate.setMonth(viewDate.getMonth() + s); renderCalendar(); }

function renderCalendar() {
    document.getElementById('calMonthTitle').innerText = `${viewDate.getFullYear()}å¹´${viewDate.getMonth()+1}æœˆ`;
    const days = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();
    const grid = document.getElementById('calGrid');
    grid.innerHTML = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(w => `<div class="text-slate-300 mb-2">${w}</div>`).join('');
    const firstDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
    for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
    for(let d=1; d<=days; d++) {
        const dStr = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayLogs = logs.filter(l => l.d === dStr);
        const score = dayLogs.reduce((sum, l) => sum + l.s, 0);
        let style = "bg-slate-50 text-slate-300 opacity-40";
        if(dayLogs.length) style = score >= 0 ? "bg-emerald-400 text-white soft-shadow" : "bg-rose-300 text-white soft-shadow";
        grid.innerHTML += `<div class="aspect-square flex flex-col items-center justify-center rounded-2xl transition-all ${style}" onclick="showDetail('${dStr}')"><span class="font-bold">${d}</span></div>`;
    }
}

function showDetail(dStr) {
    const dayLogs = logs.filter(l => l.d === dStr);
    if(!dayLogs.length) return;
    document.getElementById('dayDetail').classList.remove('hidden');
    document.getElementById('detailDate').innerText = 'ğŸ“… ' + dStr;
    document.getElementById('detailList').innerHTML = dayLogs.map(l => `<li class="flex justify-between bg-white p-4 rounded-2xl text-xs soft-shadow"><span>${l.t}</span><span class="font-bold ${l.s>0?'text-emerald-500':'text-rose-400'}">${l.s>0?'+':''}${l.s}</span></li>`).join('');
}

function renderStats() {
    const now = new Date();
    const prefix = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const mLogs = logs.filter(l => l.d.startsWith(prefix));
    const score = mLogs.reduce((sum, l) => sum + l.s, 0);
    document.getElementById('statMonthScore').innerText = score;
    document.getElementById('statMonthDays').innerText = [...new Set(mLogs.map(l => l.d))].length;
    document.getElementById('analysisContent').innerHTML = `<p class="mb-2">ğŸŒ¸ <b>æœ¬æœˆè§‰å¯Ÿï¼š</b></p><p>æ‚¨æœ¬æœˆå…±è¿›è¡Œäº† ${mLogs.length} æ¬¡åæ€ï¼Œå‡€åˆ†ä¸º ${score}ã€‚å‘½è‡ªæˆ‘é€ ï¼Œç¦è‡ªæˆ‘æ±‚ï¼Œæ—¥æ—¥ä¸æ–­ï¼ŒåŠŸä¸å”æã€‚</p>`;
}

function saveRate() {
    rate = parseFloat(document.getElementById('moneyRateInput').value) || 100;
    localStorage.setItem('kaixin_money_rate', rate);
    alert("æ›´æ–°æˆåŠŸ");
}

function doExport() {
    const data = JSON.stringify(logs, null, 2);
    const blob = new Blob([data], {type: 'text/plain'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `åŠŸè¿‡æ ¼_å¤‡ä»½_${new Date().toISOString().split('T')[0]}.txt`; a.click();
}

function doClear() { if(confirm("ç¡®å®šæ°¸ä¹…æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

init();
</script>
</body>
</html>
